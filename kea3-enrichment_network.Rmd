---
title: "KEA3 Enrichment for Hinds Kinome Manuscript"
author: "Robert M Flight"
output:
  word_document: default
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
editor_options: 
  chunk_output_type: console
---

There is an [Executive Summary](#executive-summary) at the end of this report.

## Purpose

To summarize the enrichment results from KEA3 on input lists of kinase targets via network view.

## Background on KEA3

KEA3 ([web](https://maayanlab.cloud/kea3/), [publication](https://academic.oup.com/nar/article/49/W1/W304/6279841), [my hypothes.is annotations](https://hyp.is/go?url=https%3A%2F%2Facademic.oup.com%2Fnar%2Farticle%2F49%2FW1%2FW304%2F6279841&group=__world__)) curated a list of kinase - substrate interactions from multiple sources.
Each of these sources generates a set of kinase - substrate annotations or gene-lists.
The idea is that from your experiment, you upload a list of genes that *might* interact with the kinases in KEA3, then for each source:
  * input list of genes is tested for over-representation in each list of kinase - substrate annotations (hypergeometric test or Fishers test)
  * this test generates a p-value
  * all p-values **ranked** for that source

An overall ranking **across** annotation sources is generated by taking the **average** rank (MeanRank), or reporting the **top rank** across the sources (TopRank).

When reporting results from the web application programming interface (API), we get the *MeanRank* for each kinase, as well as which genes in the input list **overlapped** with the annotated list in KEA3.
In addition, they make the kinase - substrate gene-list annotations available as gene sets.
Finally, for each annotation source, they do have the underlying raw p-values and false-discovery corrected p-values and ranks available.

## Data

```{r setup}
source(here::here("kea3_functions.R"))
save_loc = here::here("kea3_enrichment_2021-09-29")
```

### KEA3 Enriched Results

Four lists of input genes were passed to KEA3.

* PTK Human Fib vs Ctrl
* PTK Mouse Fib vs Ctrl
* STK Human Fib vs Ctrl
* STK Mouse Fib vs Ctrl

For each list of genes, they were queried on KEA3 using the [web API](https://maayanlab.cloud/kea3/templates/api.jsp), and results transformed from JSON to a list.
The code for the API queries is in "kea3_runs.R" and should be run separately from generating this document.

### Definitions

* **Enriched**: this kinase was in the **top 10** of MeanRank'ed enrichment results from KEA3 (see background on KEA3 above).
* **Overlapped**: this kinase / gene was in the input list of genes and the genes annotated to that kinase in KEA3.

### Human Protein Atlas Data

The consensus expression data from Human Protein Atlas was downloaded. 
This data will be used to limit results to genes that are known to be expressed in Liver.

## Methods

### Enrichment

For each gene list, we queried KEA3 using the publicly accessible API and stored results as simple lists in R.
**Enriched** kinases are those in the **top 10** kinases by MeanRank score.
For each of the enriched kinases, we also extracted the genes from the input list that overlap with the kinase annotation.

### Network Generation

From the KEA3 downloads page, various GMT files were downloaded.
Using the downloaded datasets, we created weighted networks of kinase-substrate pairs and protein-protein interactions.
The weight of the edge in the network between any two genes represents how many datasets that edge was observed in.
Therefore, multiple sources of evidence for the pair of proteins to be interacting adds to the weight of the network edge.

### Tissue Expression

Tissue specific gene / protein expression was defined from the Human Protein Atlas (HPA) mRNA expression consensus data, which is defined as maximum observed expression in that tissue for HPA, GTEx, Fantom5.
Expression values are first transformed using $log(expression + 1)$.
The mode for all log(expression) > 1 across all tissues was determined, and a standard deviation (SD) from values greater than the mode calculated, using the mode as the mean for the SD calculation.
A lower limit cutoff was calculated as:

$$cutoff = mode - 2 * sd$$

All genes with a log(expression) > than $cutoff$ in the tissue of interest are said to be expression in the tissue.

## Results

```{r load_kea3_data}
kea3_results = readRDS(here::here("kea3_enrichment_2021-09-29", "kea3_results.rds"))
hpa_consensus = read.table(here::here("hpa_data", "rna_consensus_2021-09-27.tsv"), header = TRUE, sep = "\t") %>%
  dplyr::mutate(logX = log1p(NX))
kea3_network = readRDS(here::here("kea3_datasets", "kea3_networks_2021-09-30.rds"))
```

First, we need to figure out what is expressed in the liver.
We previously examined how to do this in another report.
Initially, we will use what is expressed in liver, not necessarily what is "specific" to liver.

```{r find_limit}
mode_sd_all = hpa_consensus %>%
  dplyr::filter(logX > 1) %>%
  dplyr::pull(logX) %>%
  calculate_mode_sd()

min_val = mode_sd_all["mode"] - 2 * mode_sd_all["sd"]
liver_expressed = hpa_consensus %>%
  dplyr::filter(Tissue %in% "liver", logX >= min_val) %>%
  dplyr::pull(Gene.name)
min_val
```

Using this cutoff, we have `r length(liver_expressed)` genes with robust expression in the liver.
This number may be too large, and we may need to filter to what is *specific* to liver instead.

Second, lets look at the KEA3 results and the networks, filtered by what is expressed in liver.
In this one, we will use the **top ten** enriched kinases (see definitions above) using *MeanRank*, as well as their overlapping genes.

```{r kea3_results}
# changing names to make them easier to filter to.
names(kea3_results) = c("PTK_Human", "PTK_Rodent", "STK_Human", "STK_Roden")

# getting enriched kinases
human_enrich = purrr::map_dfr(kea3_results[c("PTK_Human", "STK_Human")], function(.x){
  data.frame(gene = .x$`Integrated--meanRank`$TF[1:10],
             source = "human",
             type = "kinase")
})
human_enrich = human_enrich %>%
  dplyr::filter(gene %in% liver_expressed)

# and overlapping genes, essentially the kinase targets
human_overlaps = purrr::map_dfr(kea3_results[c("PTK_Human", "STK_Human")],
                            function(.x){
  overlap_genes = .x$`Integrated--meanRank`$Overlapping_Genes[1:10]
  all_over = unlist(strsplit(overlap_genes, ","))
  data.frame(gene = all_over,
             source = "human",
             type = "target")
  }) %>%
  unique()
rownames(human_overlaps) = NULL
human_overlaps = human_overlaps %>%
  dplyr::filter(gene %in% liver_expressed)

human_overlaps = human_overlaps %>%
  dplyr::filter(!(gene %in% human_enrich))

human_results = rbind(human_enrich, human_overlaps) %>%
  dplyr::filter(gene %in% liver_expressed)

human_network = kea3_network %>%
  activate(nodes) %>%
  filter(name %in% human_results$gene) %>%
  mutate(enriched = case_when(
    name %in% human_enrich$gene ~ "enriched",
    TRUE ~ "overlap"
  )) %>%
  activate(edges) %>%
  filter(weight > 1) %>% # do we have multiple evidence?
  activate(nodes) %>%
  mutate(degree = local_size(order = 1, mindist = 1)) %>% # how many neighbors?
  filter(degree > 1)
```

OK, let's see what the network looks like?

```{r human_network_v1}
ggraph(human_network, layout = "fr") +
  geom_edge_link(aes(color = type), arrow = arrow(length = unit(4, 'mm')),
                 end_cap = circle(3, 'mm'),
                 alpha = 0.5) +
  geom_node_point(aes(color = type, shape = enriched, size = degree),
                  alpha = 0.8) +
  labs(subtitle = "Human KEA3 Results, PPI & Kinase-Targets")
```

As we can see from this plot, we have a hairball that is difficult to interpret.
Even with labels, this is not likely to make much sense.

As another solution, we will try another type of layout, and see if it helps.

```{r human_network_hive}
ggraph(human_network, layout = "hive", axis = type, sort.by = degree) +
  geom_edge_hive(aes(color = type)) +
  geom_axis_hive(aes(color = type)) +
  coord_fixed()
```

Yeah, that doesn't help us at all, unfortunately.

OK, we will try the hairball again, but remove any edges that aren't between Kinase-substrate, and then remove anything that isn't attached to something else.

```{r human_network_kt}
human_network_kt = human_network %>%
  activate(edges) %>%
  filter(type %in% "kinase-substrate") %>%
  activate(nodes) %>%
  mutate(degree = local_size(order = 1, mindist = 1)) %>%
  filter(degree > 1) %>%
  mutate(type2 = case_when(
    (type %in% "kinase") & (enriched %in% "enriched") ~ "kinase.E",
    (type %in% "kinase") & (enriched %in% "overlap") ~ "kinase.O",
    TRUE ~ "other"
  ))
```

```{r human_network_kt_graph, fig.width = 8, fig.height = 8}
# this is in it's own chunk so we can set.seed and reproduce it.
set.seed(123)
ggraph(human_network_kt, layout = "graphopt") +
  geom_edge_link(arrow = arrow(length = unit(4, 'mm')),
                 end_cap = circle(3, 'mm'),
                 alpha = 0.5) +
  geom_node_label(aes(label = name, color = type2)) +
  labs(subtitle = "Human KEA3 Results, Kinase-Targets") +
  theme(legend.position = c(0.1, 0.9))
```

```{r save_human_kt, include = FALSE}
Cairo::CairoPNG(here::here(save_loc, "human_network.png"),
                width = 8, height = 8, units = "in",
                dpi = 600, bg = "white")
set.seed(123)
ggraph(human_network_kt, layout = "graphopt") +
  geom_edge_link(arrow = arrow(length = unit(4, 'mm')),
                 end_cap = circle(3, 'mm'),
                 alpha = 0.5) +
  geom_node_label(aes(label = name, color = type2)) +
  labs(subtitle = "Human KEA3 Results, Kinase-Targets") +
  theme(legend.position = c(0.1, 0.9))
dev.off()
```

* kinase.E: A kinase gene, and enriched from KEA3
* kinase.O: A kinase gene, and overlapping in the input gene list
* other: A gene that was in the input list, and was a *target* of the kinase in the KEA3 data.

This is **starting** to look interpretable, I think.
We can see the enriched kinases, any overlapping kinases that come up from the enrichment overlapping genes, and then the overlapping genes.
I'm not sure what else should be here, so I'm going to stop.

What if we add some fold-changes from the substrates on here?

```{r add_lfc}
human_lfc_files =  dir(here::here("input"), pattern = "human.*LFC", full.names = TRUE)
human_lfc = get_lfc(human_lfc_files)
human_lfc_list = split(human_lfc$peptide2, human_lfc$direction)
human_network_kt2 = human_network_kt %>%
  activate(nodes) %>%
  dplyr::mutate(direction = dplyr::case_when(
    name %in%human_lfc_list$neg ~ "neg",
    name %in% human_lfc_list$pos ~ "pos",
    TRUE ~ "none"
  ))
```

```{r lfc_network, fig.width = 8, fig.height = 8}
set.seed(123)
ggraph(human_network_kt2, layout = "graphopt") +
  geom_edge_link(arrow = arrow(length = unit(4, 'mm')),
                 end_cap = circle(3, 'mm'),
                 alpha = 0.5) +
  geom_node_label(aes(label = name, color = direction)) +
  labs(subtitle = "Human KEA3 Results, Kinase-Targets") +
  theme(legend.position = c(0.1, 0.9))
```

```{r save_human_lfc, include = FALSE}
Cairo::CairoPNG(here::here(save_loc, "human_network_lfc.png"),
                width = 8, height = 8, units = "in",
                dpi = 600, bg = "white")
set.seed(123)
set.seed(123)
ggraph(human_network_kt2, layout = "graphopt") +
  geom_edge_link(arrow = arrow(length = unit(4, 'mm')),
                 end_cap = circle(3, 'mm'),
                 alpha = 0.5) +
  geom_node_label(aes(label = name, color = direction)) +
  labs(subtitle = "Human KEA3 Results, Kinase-Targets") +
  theme(legend.position = c(0.1, 0.9))
dev.off()
```


## Executive Summary

* Used the differential **human** peptide lists as input to KEA3 enrichment.
* Used the KEA3 kinase-substrate lists to build a gene network.
* Used the HPA consensus data to limit things to what is expressed in Liver.
* Visualized the kinase-substrate network based on the enriched kinases and the differential genes / substrates (see above), with the direction of change for the differential genes applied.

**This is a first pass only**. 
We need to talk about whether there is anything to add or do differently.
For example, we could think about directly taking the UKA results and putting them on the kinase-substrate network.
We also have ideas on how to improve on the KEA3 analysis, but we don't know if that will improve anything on this or it's necessary for this manuscript.

Finally, after reading the KEA3 manuscript, we are not sure about whether the method they use for combining across datasets is appropriate, and their emphasis on selecting only the **top XXX** results.
