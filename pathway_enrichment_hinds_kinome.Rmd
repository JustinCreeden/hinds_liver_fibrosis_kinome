---
title: "Pathway Enrichment for Hinds Kinome Manuscript"
author: "Robert M Flight"
output:
  word_document: default
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
editor_options: 
  chunk_output_type: console
---

There is an [Executive Summary](#executive-summary) at the end of this report.

## Purpose

To investigate pathway enrichment for Hinds kinome manuscript.
We will use both Gene Ontology Biological Process as it is more comprehensive, and KEGG Pathways (see get_kegg_data.R for how we got the pathway annotations), and Reactome.

## Data

Ideally all of the genes (peptides) measured on the arrays as well as the kinases that target them should constitute the background set.
However, we don't have access to them at the moment, so we will start with the kinases in KEA3 and their targets.
The foreground set is the differential things spit out by UKA.

## Methods

Hypergeometric enrichment using categoryCompare2. 
Kegg pathway annotations were pulled using the Bioconductor KEGGREST package on 2021-10-27.

## Data

```{r setup}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r load_stuff}
library(tidygraph)
library(dplyr)
library(ggraph)
library(categoryCompare2)
library(KEGGREST)
library(KEGGgraph)
library(ICIKendallTau)
theme_set(cowplot::theme_cowplot())
knitr::opts_chunk$set(fig.width = 8, fig.height = 8)
source(here::here("kea3_functions.R"))
save_loc = here::here("pathway_enrichment_2021-09-29")

gene_list_files = dir(here::here("input"), pattern = "^z", full.names = TRUE)

gene_lists = purrr::map(gene_list_files, ~ scan(.x, character(), sep = "\n", quiet = TRUE, skip = 1))
names(gene_lists) = c("human_ptk", "mouse_ptk", "human_stk", "mouse_stk")

human_list = unique(unlist(gene_lists[c("human_ptk", "human_stk")]))
mouse_list = unique(unlist(gene_lists[c("mouse_ptk", "mouse_stk")]))

specific_list = scan(here::here("input", "very_specific_genelist.txt"), what = character(), sep = "\n", quiet = TRUE)
```

## Map to Entrez ID

```{r map_entrez}
library(org.Hs.eg.db)
all_entrez = keys(org.Hs.eg.db)
org_hs_df = select(org.Hs.eg.db, keys = all_entrez, columns = "SYMBOL")

mouse_entrez = dplyr::left_join(data.frame(SYMBOL = mouse_list), org_hs_df, by = "SYMBOL") %>%
  dplyr::pull(ENTREZID)
human_entrez = dplyr::left_join(data.frame(SYMBOL = human_list), org_hs_df, by = "SYMBOL") %>%
  dplyr::pull(ENTREZID)
```

We need to filter the background down to the kinases and their targets first here, because I think we are enriched for signaling things, we are going to get signaling things in general.

```{r kinases}
kinase_files = dir(here::here("kea3_datasets"), full.names = TRUE)
kinase_files = grep("Cheng.KSIN|PTMsigDB|PhosD.All|STRING.bind", kinase_files, value = TRUE)
kinase_data = purrr::map(kinase_files, parse_gmt)
kinase_genes = unique(unlist(kinase_data))
kinase_entrez = dplyr::left_join(data.frame(SYMBOL = kinase_genes), org_hs_df, by = "SYMBOL") %>%
  dplyr::filter(!is.na(ENTREZID)) %>%
  dplyr::pull(ENTREZID)

specific_entrez = dplyr::left_join(data.frame(SYMBOL = specific_list), org_hs_df, by = "SYMBOL") %>%
  dplyr::filter(!is.na(ENTREZID)) %>%
  dplyr::pull(ENTREZID)
```

## GO Enrichment

```{r go_enrichment}
go_all = readRDS(here::here("go_all.rds"))
go_bp = readRDS(here::here("go_bp.rds"))
human_go_all = hypergeometric_feature_enrichment(
  new("hypergeom_features", significant = human_entrez,
      universe = kinase_entrez,
      annotation =  go_all),
  p_adjust = "BH"
)
human_go_bp = hypergeometric_feature_enrichment(
  new("hypergeom_features", significant = human_entrez,
      universe = kinase_entrez,
      annotation = go_bp),
  p_adjust = "BH"
)

mouse_go_all = hypergeometric_feature_enrichment(
  new("hypergeom_features", significant = mouse_entrez,
      universe = kinase_entrez,
      annotation =  go_all),
  p_adjust = "BH"
)
mouse_go_bp = hypergeometric_feature_enrichment(
  new("hypergeom_features", significant = mouse_entrez,
      universe = kinase_entrez,
      annotation = go_bp),
  p_adjust = "BH"
)

all_go = combine_enrichments(human = human_go_all,
                             mouse = mouse_go_all)

gocut = 0.001

all_go_sig = get_significant_annotations(all_go, padjust <= gocut, counts >= 2)

goall_table = extract_stats_table(all_go_sig, specific_entrez)


bp_go = combine_enrichments(human = human_go_bp,
                            mouse = mouse_go_bp)
bp_sig = get_significant_annotations(bp_go, padjust <= gocut, counts >= 2)

gobp_table = extract_stats_table(bp_sig, specific_entrez)
dim(gobp_table)
```

Nice!
If we don't find anything via KEGG, we have something to fall back on.

## KEGG

```{r kegg_enrichment}
kegg_annotation = readRDS(here::here("kegg_annotation.rds"))

all_kegg = unique(unlist(kegg_annotation@annotation_features))

human_kegg = hypergeometric_feature_enrichment(
  new("hypergeom_features", significant = human_entrez,
      universe = kinase_entrez,
      annotation = kegg_annotation),
  p_adjust = "BH"
)

mouse_kegg = hypergeometric_feature_enrichment(
  new("hypergeom_features", significant = mouse_entrez,
      universe = kinase_entrez,
      annotation = kegg_annotation),
  p_adjust = "BH"
)

kegg_enrich = combine_enrichments(human = human_kegg,
                                  mouse = mouse_kegg)
kegg_sig = get_significant_annotations(kegg_enrich, padjust <= gocut, counts >= 2)

kegg_table = extract_stats_table(kegg_sig, specific_entrez)
```

Now with this table, we will filter down to things that include "signaling" in the description.

```{r filter_signaling, include = FALSE}
kegg_signaling = kegg_table %>%
  dplyr::filter(grepl("signaling", pathway, ignore.case = TRUE)) %>%
  dplyr::arrange(desc(human.odds))
```

And let's play with the VEGF signaling one, which is the top one.

```{r vegf_signaling, include = FALSE}
vegf = keggGet(kegg_signaling$path_id[1], "kgml")
vegf_df = parseKGML2DataFrame(vegf)
vegf_df = vegf_df %>%
  dplyr::mutate(from = gsub("hsa:", "", from),
                to = gsub("hsa:", "", to))

vegf_graph = tidygraph::as_tbl_graph(vegf_df)
vegf_graph = vegf_graph %>%
  activate(nodes) %>%
  mutate(mouse = name %in% mouse_entrez,
         human = name %in% human_entrez) %>%
  dplyr::left_join(., org_hs_df, by = c("name" = "ENTREZID"))

ggraph(vegf_graph, "graphopt") +
  geom_node_label(aes(label = SYMBOL, fill = human)) +
  geom_edge_link(aes(color = subtype))
```

```{r alcoholic_disease, include = FALSE}
nash_kgml = kegg_table %>%
  dplyr::filter(grepl("alcohol", pathway)) %>%
  dplyr::pull(path_id) %>%
  keggGet("kgml")
nash_df = parseKGML2DataFrame(nash_kgml) %>%
  dplyr::mutate(from = gsub("hsa:", "", from),
                to = gsub("hsa:", "", to))
nash_graph = tidygraph::as_tbl_graph(nash_df)
nash_graph = nash_graph %>%
  activate(nodes) %>%
  mutate(mouse = name %in% mouse_entrez,
         human = name %in% human_entrez) %>%
  dplyr::left_join(., org_hs_df, by = c("name" = "ENTREZID"))

ggraph(nash_graph, "graphopt") +
  geom_node_label(aes(label = SYMBOL, fill = human)) +
  geom_edge_link(aes(color = subtype))
```

## Reactome

So, one issue with the KEGG pathways, is they don't seem to contain an annotation for one particular gene of interest, DDR1.
In contrast, reactome seems to have it.

```{r reactome_annotation}
reactome_annotation = readRDS(here::here("reactome_annotation.rds"))
reactome_path_ddr1 = "R-HSA-1474244"
```

```{r reactome_enrichment}
human_reactome = hypergeometric_feature_enrichment(
  new("hypergeom_features", significant = human_entrez,
      universe = kinase_entrez,
      annotation = reactome_annotation),
  p_adjust = "BH"
)

mouse_reactome = hypergeometric_feature_enrichment(
  new("hypergeom_features", significant = mouse_entrez,
      universe = kinase_entrez,
      annotation = reactome_annotation),
  p_adjust = "BH"
)
reactome_cut = 0.005
reactome_enrich = combine_enrichments(human = human_reactome,
                                  mouse = mouse_reactome)
reactome_sig = get_significant_annotations(reactome_enrich, padjust <= reactome_cut, counts >= 2)
reactome_table = extract_stats_table(reactome_sig, specific_entrez)
```


As I've looked at these results, I've noticed some interesting themes, namely processes and pathways that involve a large amount of extracellular matrix reorganization / adhesion, and various signaling pathways.

The various signaling pathways make sense, because we are looking at the targets of kinase signaling.

The extracellular matrix stuff is interesting, because fibrosis necessarily involves a good amount of extracellular matrix and cellular adhesion processes / pathways.

We will put those into a separate table in the Excel file.

```{r show_matrix_adhesion}
reactome_table$source = "reactome"
gobp_table$source = "GO.BP"
kegg_table$source = "KEGG"

all_results = rbind(gobp_table,
                    kegg_table,
                    reactome_table)
interesting_table = all_results %>%
  dplyr::filter(grepl("matrix|adhes.*|signaling", pathway, ignore.case = TRUE))
dim(interesting_table)
```

```{r export_tables, eval = FALSE}
kegg_table = add_genes(kegg_table, kegg_sig, org_hs_df)
gobp_table = add_genes(gobp_table, bp_sig, org_hs_df)
reactome_table = add_genes(reactome_table, reactome_sig, org_hs_df)

export_pathway_tables(list(KEGG = kegg_table,
                           REACTOME = reactome_table,
                           GOBP = gobp_table,
                           ADHESION = interesting_table),
                      pathway_file = "pathway_tables.xlsx")
```

Finally, we can use Kendall-tau correlation to ask how similar the p-values are within each table between mouse and human.
The list includes anything that was **significant** (below the p-value cutoff) for either mouse or human.

```{r ici_kt_tables, fig.width = 3, fig.height=9}
split_source = split(all_results, all_results$source)
ici_source = purrr::map_df(split_source, function(.x){
  ici_res = ici_kt(.x$mouse.padjust, .x$human.padjust, "global")
  text_res = paste0("ICI-Kt: ", format(ici_res["tau"], digits = 2), "\n",
                    " P-Value: ", format(ici_res["pvalue"], digits = 2))
  data.frame(source = .x$source[1],
             tau = ici_res["tau"],
             pvalue = ici_res["pvalue"],
             text = text_res)
})

ici_values = all_results %>%
  dplyr::group_by(source) %>%
  dplyr::summarise(ici_kt = ici_kt(human.padjust, mouse.padjust, "global")[1])

knitr::kable(ici_values, digits = 2)

sig_cuts = data.frame(cut = c(gocut, gocut, reactome_cut),
                      source = c("GO.BP",
                                 "KEGG",
                                 "reactome"))
ici_source$x = 13
ici_source$y = 30

sig_plots = ggplot(all_results, aes(x = -1 * log10(human.padjust), y = -1 * log10(mouse.padjust))) + geom_point(alpha = 0.5) +
  geom_hline(aes(yintercept = -1 * log10(cut)), data = sig_cuts, color = "red") +
  geom_vline(aes(xintercept = -1 * log10(cut)), data = sig_cuts, color = "red") +
  geom_abline(slope = 1, color = "blue") +
  geom_text(data = ici_source, aes(x = x, y = y, label = text)) +
  facet_wrap(~ source, ncol = 1) +
  coord_equal() +
  labs(x = "Human Adjusted-PValues",
       y = "Mouse Adjusted-PValues")
sig_plots
```

Log10 Adjusted-PValues with P-Value cutoffs indicated by red lines and perfect agreement by blue lines.
Points in a specific quadrant indicate pathways significant in only that organism.

## Executive Summary

* Data:
  * Gene Ontology biological process (GO.BP), KEGG pathways, and Reactome pathways.
  * Significant kinase targets from UKA (significant genes) for both Mouse and Human.
We merged STK and PTK results together.
  * Kinases and their targets from KEA3 (background genes).
* Process:
  * Map symbols to Entrez IDs using org.Hs.eg.db.
  * Hypergeometric enrichment using categoryCompare2.
  * Significant enrichment are those with at least 2 genes annotated, and then adjusted p-values <=
    * GO.BP: `r gocut`
    * KEGG: `r gocut`
    * reactome: `r reactome_cut`
* Results:
  * See **pathway_tables_XXX.xlsx** for the enriched pathways.
  * Signaling, in all three sources.
This isn't that surprising given we have the kinases.
I had hoped modifying the background would suppress these enrichments a bit, but no luck.
  * KEGG, returned the pathway "Non-alcoholic fatty liver disease" as significant in both mouse and human, which is one pathway that leads to liver fibrosis.
  * Also the pathways "Axon guidance", "Osteoclast differentiation", "Focal adhesion" and "Adherens junction" all involve extracellular matrix regulation.
  * Similar story in Reactome.
  * GO.BP also has things related to extracellular matrix and adhesion.
  * We compared the adjusted p-value results of enrichment between human and mouse using Kendall correlation and plotted them against each other.
