---
title: "KEA3 Enrichment for Hinds Kinome Manuscript"
author: "Robert M Flight"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
editor_options: 
  chunk_output_type: console
---

## Purpose

To summarize the enrichment results from KEA3 on input lists of kinase targets.

## Data

```{r setup}
source(here::here("kea3_functions.R"))
```

### KEA3 Enriched Results

Four lists of input genes were passed to KEA3.

* PTK Human Fib vs Ctrl
* PTK Mouse Fib vs Ctrl
* STK Human Fib vs Ctrl
* STK Mouse Fib vs Ctrl

For each list of genes, they were queried on KEA3 using the [web API](https://maayanlab.cloud/kea3/templates/api.jsp), and results transformed from JSON to a list.
The code for the API queries is in "kea3_runs.R" and should be run separately from generating this document.

The results here include:

* Enrichment Scores
* Ranks for a particular method
* Which genes are targets of the kinase

### Human Protein Atlas Data

The consensus expression data from Human Protein Atlas was downloaded. 
This data will be used to limit results to genes that are known to be expressed in Liver.

## Methods

Query gene list inputs on KEA3 using their API.
From downloaded datasets, filter genes 


## Results

```{r load_kea3_data}
kea3_results = readRDS(here::here("kea3_enrichment_2021-09-29", "kea3_results.rds"))
hpa_consensus = read.table(here::here("hpa_data", "rna_consensus_2021-09-27.tsv"), header = TRUE, sep = "\t") %>%
  dplyr::mutate(logX = log1p(NX))
kea3_network = readRDS(here::here("kea3_datasets", "kea3_networks_2021-09-30.rds"))
```

First, we need to figure out what is expressed in the liver.
We previously examined how to do this in another report.
Initially, we will use what is expressed in liver, not necessarily what is "specific" to liver.

```{r find_limit}
mode_sd_all = hpa_consensus %>%
  dplyr::filter(logX > 1) %>%
  dplyr::pull(logX) %>%
  calculate_mode_sd()

min_val = mode_sd_all["mode"] - 2 * mode_sd_all["sd"]
liver_expressed = hpa_consensus %>%
  dplyr::filter(Tissue %in% "liver", logX >= min_val) %>%
  dplyr::pull(Gene.name)
```

Second, lets look at the KEA3 results and the networks, filtered by what is expressed in liver.

```{r kea3_results}
names(kea3_results) = c("PTK_Human", "PTK_Rodent", "STK_Human", "STK_Roden")

human_res = purrr::map(kea3_results[c("PTK_Human", "STK_Human")], function(.x){
  .x$`Integrated--meanRank`$TF[1:10]
}) %>%
  unlist(.)

human_overlaps = purrr::map(kea3_results[c("PTK_Human", "STK_Human")],
                            function(.x){
  over_genes = .x$`Integrated--meanRank`$Overlapping_Genes[1:10]
  all_over = unlist(strsplit(over_genes, ","))
                            }) %>%
  unlist() %>%
  unique()

human_network = kea3_network %>%
  activate(nodes) %>%
  filter((name %in% liver_expressed) & (name %in% human_overlaps)) %>%
  mutate(enriched = case_when(
    name %in% human_res ~ "enriched",
    TRUE ~ "other"
  )) %>%
  activate(edges) %>%
  filter(weight > 1, type %in% "kinase-substrate") %>% # do we have multiple evidence?
  activate(nodes) %>%
  mutate(degree = local_size(order = 1, mindist = 1)) %>% # how many neighbors?
  filter(degree > 1)
```

OK, let's see what the network looks like?

```{r plot_ks}
ggraph(human_network, layout = "fr") +
  geom_edge_link(aes(color = type), arrow = arrow(length = unit(4, 'mm')),
                 end_cap = circle(3, 'mm')) +
  geom_node_point(aes(color = is_kinase, size = degree))
```